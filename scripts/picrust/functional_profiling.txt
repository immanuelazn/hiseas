############################################################################
# Q2-PICRUST2 PIPELINE.  USED PRIMARILY FOR DIVERSITY ANALYSIS
# Get reference database
wget http://kronos.pharmacology.dal.ca/public_files/picrust/picrust2_tutorial_files/picrust2_default_sepp_ref.qza \
     -O picrust2_default_sepp_ref.qza 


# Fragment insert using open reference method, IMG database
qiime fragment-insertion sepp --i-representative-sequences rep_set_290.qza \
                              --p-threads 10 \
                              --i-reference-database picrust2_default_sepp_ref.qza \
                              --output-dir q2-picrust2-insert-tree

# Run the rest of picrust pipeline
qiime picrust2 custom-tree-pipeline --i-table frequency-filtered-surface-table-no-mito.qza \
                                    --i-tree q2-picrust2-insert-tree/tree.qza \
                                    --output-dir q2-picrust2_output \
                                    --p-threads 10 \
                                    --p-hsp-method mp \
                                    --p-max-nsti 2 \
				    --p-edge-exponent 0 \
                                    --verbose

# Summarize feature tables
#KOs
qiime feature-table summarize \
  --i-table ./ko_metagenome.qza  \
  --o-visualization ./ko_metagenome.qzv

#ECs
qiime feature-table summarize \
  --i-table ./ec_metagenome.qza  \
  --o-visualization ./ec_metagenome.qzv

#Pathabun
qiime feature-table summarize \
  --i-table ./pathway_abundance.qza  \
  --o-visualization ./pathway_abundance.qzv



# Calculate metrics with rarify depth based on minimum pathway abundance
qiime diversity core-metrics \
   --i-table q2-picrust_output/pathway_abundance.qza \
   --p-sampling-depth 1694943 \
   --m-metadata-file hiseas_metadata.txt \
   --output-dir core-metrics \
   --p-n-jobs 6

# Shannon diversity between plastic and wood orig env material
qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics/shannon_vector.qza \
  --m-metadata-file hiseas_metadata.txt \
  --o-visualization core-metrics/shannon-significance.qzv

# Beta Significance

qiime diversity beta-group-significance \
  --i-distance-matrix core-metrics/bray_curtis_distance_matrix.qza \
  --m-metadata-file hiseas_metadata.txt \
  --m-metadata-column orig_env_material \
  --o-visualization core-metrics/bray-curtis-surface-significance.qzv




#Differential Abundance using ANCOM
# Convert types FeatureTable[Frequency] into FeatureTable[Composition]  by adding a pseudocount
qiime composition add-pseudocount \
  --i-table q2-picrust_output/pathway_abundance.qza \
  --o-composition-table pathway_abundance_comp.qza

qiime composition ancom \
  --i-table pathway_abundance_comp.qza \
  --m-metadata-file hiseas_metadata.txt \
  --m-metadata-column orig_env_material \
  --o-visualization ancom_material.qzv


#Export abundance and ko
qiime tools export \
   --input-path pathway_abundance.qza \
   --output-path path-exported

biom convert \
   -i path-exported/feature-table.biom \
   -o path-exported/feature-table.biom.tsv \
   --to-tsv

qiime tools export \
   --input-path ko_metagenome.qza \
   --output-path path-exported-ko

biom convert \
   -i path-exported-ko/feature-table.biom \
   -o path-exported-ko/feature-table.biom.tsv \
   --to-tsv

########################################################################################################################### 

# FOR STANDALONE PICRUST2 PIPELINE
qiime tools export \
   --input-path frequency-filtered-surface-table-no-mito.qza \
   --output-path picrust2-standalone-inputs

qiime tools export \
   --input-path rep_set_290.qza \
   --output-path picrust2-standalone-inputs


# Run full pipeline of PICRUSt2 standalone using outputs from QIIME2
# Sequence placement using HMMER multiple sequence alignment into open reference tree placed with epa-ng.  ASVs with NSTI values of >2 excluded from output
# Gappa automatically exececuted to turn .jplace into newick format
# HSP  of 16S copy, EC numbers and KO abundances per genome using maximum parisomy under castor package
# Then predict EC and KO abundances in sequences samples 
# Infer  pathway abundances using predicted EC number abundances using MinPath
picrust2_pipeline.py -s dna-sequences.fasta -i feature-table.biom \
					    -o picrust2_out_pipeline -p 10 \
					    --stratified --verbose



# Add functional descriptions as a new column for each functional id for unstrat


add_descriptions.py -i EC_metagenome_out/pred_metagenome_unstrat.tsv.gz -m EC \
                    -o EC_metagenome_out/pred_metagenome_unstrat_descrip.tsv.gz

add_descriptions.py -i KO_metagenome_out/pred_metagenome_unstrat.tsv.gz -m KO \
                    -o KO_metagenome_out/pred_metagenome_unstrat_descrip.tsv.gz

add_descriptions.py -i pathways_out/path_abun_unstrat.tsv.gz -m METACYC\
                    -o pathways_out/path_abun_unstrat_descrip.tsv.gz

########################################################################################################################### 

# Then I used R to remove the pathway column and only keep the descrip column, then exported as a tsv and added a descriptor column name manually.
# NOTE: for some reason the pathway abundance script didnt work as a tsv for exporting but worked as a csv.  Therefore, I turned into a csv and manually removed tabs and commas.

# Also used R to detemrine NSTI predicted values for ASVs and samples.


#######################################################################################################################################
# STAMP
# Convert BIOM to tsv for use in stamp after L3 KO conversion in R

biom convert -i l3-ko-.biom -o l3-ko.tsv --to-tsv


